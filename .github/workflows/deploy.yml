name: Deploy to AWS S3
# Workflow with corrected S3 bucket permissions

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build Next.js
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          # Sync ALL files first (this handles images, fonts, etc.)
          aws s3 sync ./out s3://${{ secrets.AWS_S3_BUCKET }}/dashboard --delete

          # Fix content-types for CSS files (including nested _next folders)
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/dashboard s3://${{ secrets.AWS_S3_BUCKET }}/dashboard \
            --recursive \
            --exclude "*" \
            --include "*.css" \
            --content-type "text/css" \
            --metadata-directive REPLACE

          # Fix content-types for JS files (including nested _next folders)
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/dashboard s3://${{ secrets.AWS_S3_BUCKET }}/dashboard \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --content-type "application/javascript" \
            --metadata-directive REPLACE

          # Fix content-types for HTML files
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/dashboard s3://${{ secrets.AWS_S3_BUCKET }}/dashboard \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --content-type "text/html" \
            --metadata-directive REPLACE

      - name: Configure S3 routing for SPA paths
        run: |
          # Create routing rules to handle SPA routing in dashboard subfolder
          # When a path doesn't exist (404), serve the dashboard root index.html
          cat > /tmp/website-config.json << 'EOF'
          {
            "IndexDocument": {
              "Suffix": "index.html"
            },
            "RoutingRules": [
              {
                "Condition": {
                  "HttpErrorCodeReturnedEquals": "404",
                  "KeyPrefixEquals": "dashboard/"
                },
                "Redirect": {
                  "HostName": "${{ secrets.AWS_S3_BUCKET }}",
                  "ReplaceKeyWith": "dashboard/index.html",
                  "HttpRedirectCode": "200"
                }
              }
            ]
          }
          EOF

          # Apply website configuration
          aws s3api put-bucket-website \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --website-configuration file:///tmp/website-config.json 2>/dev/null || true
